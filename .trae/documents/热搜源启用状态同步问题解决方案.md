# 热搜源启用状态同步问题解决方案

## 问题分析

1. **当前实现问题**
   - `toggleSourceEnabled` 函数只更新本地状态，未将状态变化同步到后端或持久化存储
   - `fetchHotsearchSources` 函数总是将 `enabled` 状态默认设置为 `true`，忽略了用户的实际操作
   - 后端没有提供管理热搜源启用状态的API端点

2. **预期行为**
   - 点击按钮切换状态后，状态应持久化保存
   - 页面刷新后，应根据保存的状态正确显示按钮状态
   - 理想情况下，状态应与后端同步，实现多设备共享

## 解决方案

### 1. 前端状态持久化（LocalStorage）

**修改点**：
- `toggleSourceEnabled` 函数：添加状态持久化逻辑
- `fetchHotsearchSources` 函数：从持久化存储读取状态

**实现思路**：
- 使用 LocalStorage 保存平台启用状态
- 页面加载时优先读取 LocalStorage 中的状态
- 状态变化时更新 LocalStorage

### 2. 后端API支持（可选）

**修改点**：
- 后端添加热搜源管理API端点
- 前端调用API同步状态到后端

**实现思路**：
- 在 `config` 路由下添加热搜源管理端点
- 实现获取、更新热搜源状态的控制器方法
- 前端调用API进行状态同步

## 实施计划

### 阶段1：前端状态持久化（立即实施）

1. 修改 `fetchHotsearchSources` 函数：
   - 从 LocalStorage 读取保存的启用状态
   - 如果没有保存状态，使用默认值 `true`

2. 修改 `toggleSourceEnabled` 函数：
   - 更新本地状态后，将状态保存到 LocalStorage
   - 显示成功提示

### 阶段2：后端API支持（后续优化）

1. 后端添加 API 端点：
   - `GET /api/v1/config/hotsearch-sources` - 获取热搜源列表
   - `PUT /api/v1/config/hotsearch-sources/:id` - 更新热搜源状态

2. 前端调用 API：
   - 替换 LocalStorage 持久化，使用 API 同步状态
   - 确保状态在多设备间保持一致

## 代码修改示例

### 前端修改

**1. 修改 fetchHotsearchSources 函数**
```javascript
const fetchHotsearchSources = async () => {
  try {
    setSourcesLoading(true);
    // Call API to get hotsearch sources
    const result = await apiService.tasks.getLogs('hotsearch', { limit: 5 });
    // Transform task logs into hotsearch sources format
    const sourcesData = result.data || [];
    const platforms = ['douyin', 'xiaohongshu', 'weibo', 'kuaishou', 'bilibili'];
    
    // Get saved enabled status from localStorage
    const savedEnabledStatus = JSON.parse(localStorage.getItem('hotsearchEnabledStatus')) || {};
    
    // Create sources based on available platforms
    const transformedSources = platforms.map((platform, index) => {
      const platformLogs = sourcesData.filter(log => log.platform === platform);
      const lastLog = platformLogs[0];
      
      return {
        id: `${index + 1}`,
        platform,
        enabled: savedEnabledStatus[platform] !== undefined ? savedEnabledStatus[platform] : true,
        frequency: 'daily',
        last_crawled: lastLog?.createdAt || '从未抓取'
      };
    });
    
    setHotsearchSources(transformedSources);
  } catch (error) {
    // Error handling...
  } finally {
    setSourcesLoading(false);
  }
};
```

**2. 修改 toggleSourceEnabled 函数**
```javascript
const toggleSourceEnabled = async (sourceId, currentStatus) => {
  try {
    const newStatus = !currentStatus;
    
    // Update local state
    setHotsearchSources(prevSources => {
      const updatedSources = prevSources.map(source => 
        source.id === sourceId ? { ...source, enabled: newStatus } : source
      );
      
      // Save enabled status to localStorage
      const enabledStatus = {};
      updatedSources.forEach(source => {
        enabledStatus[source.platform] = source.enabled;
      });
      localStorage.setItem('hotsearchEnabledStatus', JSON.stringify(enabledStatus));
      
      return updatedSources;
    });
    
    message.success(`已${newStatus ? '启用' : '禁用'}该平台热搜抓取`);
  } catch (error) {
    console.error('Failed to toggle source status:', error);
    message.error(error.message || '更新热搜源状态失败');
  }
};
```

## 预期效果

1. **页面刷新后状态保持**：点击按钮切换状态后，页面刷新仍显示正确状态
2. **状态持久化**：状态保存在 LocalStorage 中，关闭浏览器后重新打开仍保持
3. **良好的用户体验**：状态切换流畅，无明显延迟
4. **可扩展性**：后续可轻松添加后端API支持，实现多设备同步

## 后续优化建议

1. **后端API支持**：实现完整的后端API，支持状态的持久化存储和多设备同步
2. **状态验证**：添加状态验证逻辑，确保状态的一致性和有效性
3. **批量操作**：支持批量启用/禁用多个平台的热搜抓取
4. **权限控制**：添加权限控制，限制只有管理员可以修改热搜源状态

通过以上方案，我们可以解决当前热搜源启用状态不同步的问题，确保用户操作能够正确持久化保存。