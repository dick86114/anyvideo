## 问题分析

### 1. 现象
- 点击删除按钮、批量删除和批量导出功能时，系统提示"服务器内部错误，请稍后重试"
- 浏览器控制台显示500 Internal Server Error

### 2. 根本原因
通过日志分析，发现所有数据库操作都超时失败，错误信息如下：
```
MongooseError: Operation `users.find()` buffering timed out after 10000ms
```

### 3. 问题链路
1. MongoDB连接失败（原因可能是连接字符串错误或MongoDB服务未运行）
2. 但系统仍启动并接受请求
3. 控制器尝试执行数据库操作
4. 数据库操作超时（10秒后）
5. 服务器返回500错误
6. 前端响应拦截器显示"服务器内部错误，请稍后重试"

## 修复方案

### 方案1：实现数据库连接状态检查（推荐）

#### 核心思路
- 在应用启动时检查MongoDB连接状态
- 实现中间件，对所有API请求检查数据库连接状态
- 当数据库未连接时，返回503 Service Unavailable状态码
- 前端显示友好的错误信息

#### 实现步骤

1. **修改db.js文件**
   - 导出MongoDB连接状态
   - 添加重试机制

2. **实现数据库状态中间件**
   - 在app.js中添加中间件
   - 检查数据库连接状态
   - 未连接时返回503错误

3. **修改前端响应拦截器**
   - 添加对503状态码的处理
   - 显示友好的错误信息

4. **修复所有控制器**
   - 添加try-catch块
   - 捕获数据库操作超时错误
   - 返回适当的错误信息

### 方案2：修复MongoDB连接问题

#### 核心思路
- 确保MongoDB服务正常运行
- 检查并修复连接字符串
- 确保MongoDB权限配置正确

#### 实现步骤

1. **检查MongoDB服务**
   - 启动MongoDB服务
   - 确保服务在指定端口运行

2. **检查连接字符串**
   - 验证.env文件中的MONGODB_URI配置
   - 确保连接字符串格式正确

3. **测试连接**
   - 使用mongo shell测试连接
   - 确保数据库用户有正确权限

## 推荐方案

**推荐使用方案1**，原因如下：
1. 即使修复了MongoDB连接，仍可能出现临时断开情况
2. 实现数据库状态检查可以提高系统的健壮性
3. 为用户提供更友好的错误信息
4. 便于系统监控和维护

## 具体修复代码

### 1. 修改db.js文件
```javascript
const mongoose = require('mongoose');
require('dotenv').config();

let isConnected = false;

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('MongoDB connected successfully');
    isConnected = true;
  } catch (error) {
    console.error('MongoDB connection error:', error);
    console.log('Continuing without MongoDB connection...');
    isConnected = false;
    // Try to reconnect every 5 seconds
    setTimeout(connectDB, 5000);
  }
};

const getDBConnectionStatus = () => isConnected;

module.exports = {
  connectDB,
  getDBConnectionStatus
};
```

### 2. 添加数据库状态中间件
```javascript
// 在app.js中添加
const { getDBConnectionStatus } = require('./utils/db');

// Database connection check middleware
app.use((req, res, next) => {
  if (!getDBConnectionStatus()) {
    return res.status(503).json({
      status: 'error',
      message: '数据库连接不可用，请稍后重试',
      code: 503
    });
  }
  next();
});
```

### 3. 修改前端响应拦截器
```javascript
// 在api.js中修改
if (error.response && error.response.status === 503) {
  return Promise.reject(new Error('数据库连接不可用，请稍后重试'));
}
```

### 4. 修复ContentController.js
```javascript
// 在每个控制器方法中添加try-catch和超时处理
static async deleteContent(req, res) {
  try {
    const { id } = req.params;
    
    const content = await Content.findByIdAndDelete(id).timeout(5000); // Add timeout
    if (!content) {
      return res.status(404).json({ message: '内容不存在' });
    }
    
    // Rest of the code...
    
  } catch (error) {
    if (error.name === 'MongooseTimeoutError' || error.name === 'TimeoutError') {
      return res.status(503).json({ message: '数据库操作超时，请稍后重试' });
    }
    console.error('Delete content error:', error);
    res.status(500).json({ message: '删除内容失败' });
  }
}
```

## 测试方案

### 1. 数据库连接失败场景
- 停止MongoDB服务
- 测试删除、批量删除和批量导出功能
- 预期结果：显示"数据库连接不可用，请稍后重试"

### 2. 数据库连接恢复场景
- 启动MongoDB服务
- 测试删除、批量删除和批量导出功能
- 预期结果：所有功能正常工作

### 3. 正常操作场景
- 确保MongoDB服务运行正常
- 测试单个删除功能
  - 选择一个内容项，点击删除按钮
  - 预期结果：删除成功，显示成功提示
- 测试批量删除功能
  - 选择多个内容项，点击批量删除按钮
  - 预期结果：删除成功，显示成功提示
- 测试批量导出功能
  - 选择多个内容项，点击批量导出按钮
  - 预期结果：生成Excel文件并下载，显示成功提示

## 预期效果

1. **错误信息友好**：用户不再看到"服务器内部错误"，而是看到具体的错误原因
2. **系统健壮性提高**：能够处理数据库连接失败的情况
3. **便于维护**：管理员可以通过日志和状态码快速定位问题
4. **功能恢复正常**：当MongoDB连接恢复后，所有功能自动恢复正常

## 修复优先级

1. 高优先级：修复db.js和添加数据库状态中间件
2. 中优先级：修改前端响应拦截器
3. 低优先级：修复所有控制器的错误处理

通过以上修复方案，我们可以系统性地解决服务器内部错误问题，提高系统的健壮性和用户体验。